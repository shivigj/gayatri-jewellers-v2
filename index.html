<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>Gayatri Jewellers</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  const firebaseConfig = {
    apiKey: "AIzaSyBK8p-lRmx1TfU2fx_Hed7ioUKieJKwLII",
    authDomain: "gayatri-jewellers-v2.firebaseapp.com",
    databaseURL: "https://gayatri-jewellers-v2-default-rtdb.firebaseio.com",
    projectId: "gayatri-jewellers-v2",
    storageBucket: "gayatri-jewellers-v2.firebasestorage.app",
    messagingSenderId: "919249152249",
    appId: "1:919249152249:web:16e64c5cc08a2f709e5a28",
    measurementId: "G-YPY75MNWPL"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  window._db=db; window._ref=ref; window._onValue=onValue;
  window._set=set; window._push=push; window._remove=remove;
  window._firebaseReady=true;
  document.dispatchEvent(new Event('firebase-ready'));
</script>

<style>
:root{
  --gold:#B8960C; --gold2:#C9A84C; --gold3:#E2C97E; --gold-bg:#FAF6E9;
  --gold-border:#E5D48A; --cream:#FDFAF3; --cream2:#F5F0E4;
  --dark:#1A1714; --brown:#3D2E14; --mid:#6B5A38; --muted:#9C8E72;
  --white:#FFFFFF; --border:#EDE6D0; --bg:#F5F0E4;
  --red:#C0392B; --green:#25A244;
  --shadow:0 1px 4px rgba(0,0,0,0.06); --shadow2:0 4px 20px rgba(0,0,0,0.10);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--dark);max-width:480px;margin:0 auto;display:flex;flex-direction:column;}

/* LOADING */
#loading{position:fixed;inset:0;background:var(--cream);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:14px;}
.load-ring{width:52px;height:52px;border-radius:50%;border:3px solid var(--cream2);border-top-color:var(--gold2);animation:spin .9s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.load-name{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--gold2);}

/* LOGIN */
#login-screen{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:24px;background:var(--cream);}
.login-logo{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,#9A7B0A,#C9A84C);display:flex;align-items:center;justify-content:center;font-size:30px;color:#fff;margin:0 auto 18px;box-shadow:0 8px 24px rgba(180,140,20,.30);}
.login-brand{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;color:var(--dark);text-align:center;margin-bottom:3px;}
.login-sub{font-size:10px;color:var(--gold2);letter-spacing:3px;text-align:center;margin-bottom:36px;}
.login-card{background:#fff;border:1px solid var(--border);border-radius:20px;padding:32px 24px;width:100%;max-width:340px;box-shadow:var(--shadow2);}
.lbl{font-size:11px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px;display:block;}
.linput{width:100%;border:1.5px solid var(--border);border-radius:10px;padding:13px;font-size:20px;font-family:monospace;letter-spacing:8px;text-align:center;outline:none;background:var(--cream);transition:border .2s;}
.linput:focus{border-color:var(--gold2);}
.lerr{font-size:12px;color:var(--red);text-align:center;margin-top:8px;min-height:18px;}
.lbtn{width:100%;background:linear-gradient(135deg,#9A7B0A,#C9A84C);color:#fff;border:none;border-radius:10px;padding:14px;font-size:14px;font-weight:600;letter-spacing:1px;cursor:pointer;margin-top:14px;font-family:'DM Sans',sans-serif;}
.lbtn:active{opacity:.9;}

/* APP SHELL */
#app-shell{display:none;flex-direction:column;height:100vh;overflow:hidden;}

/* TOP BAR */
.top-bar{background:#fff;border-bottom:1px solid var(--border);padding:8px 16px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
.tb-brand-name{font-family:'Cormorant Garamond',serif;font-size:19px;font-weight:700;color:var(--dark);line-height:1.1;}
.tb-brand-sub{font-size:9px;color:var(--muted);letter-spacing:2px;}
.tb-date{font-size:9px;color:var(--gold2);letter-spacing:.5px;font-weight:600;margin-top:2px;}
.tb-right{display:flex;gap:8px;align-items:center;}
.owner-badge{background:linear-gradient(135deg,#9A7B0A,#C9A84C);color:#fff;border:none;border-radius:20px;padding:5px 14px;font-size:11px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;}
.staff-badge{background:#fff;color:var(--gold2);border:1.5px solid var(--gold-border);border-radius:20px;padding:5px 14px;font-size:11px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;}
.exit-btn2{background:none;border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:11px;cursor:pointer;color:var(--muted);font-family:'DM Sans',sans-serif;}

/* SCROLL */
.main-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--bg);}

/* SCREENS */
.screen{display:none;}
.screen.active{display:block;}

/* HOME */
.home-pad{padding:12px;}
.rate-card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
.rate-label{font-size:10px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:3px;}
.rate-value{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;color:var(--dark);}
.rate-sub{font-size:11px;color:var(--muted);margin-top:1px;}
.rate-input-box{border:1.5px solid var(--border);border-radius:8px;padding:8px 12px;font-size:15px;font-weight:600;color:var(--dark);background:var(--cream);width:90px;text-align:center;outline:none;font-family:'DM Sans',sans-serif;}
.rate-input-box:focus{border-color:var(--gold2);}
.find-card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:10px;}
.find-label{font-size:10px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:10px;}
.find-row{display:flex;gap:8px;}
.find-input{flex:1;border:1.5px solid var(--border);border-radius:10px;padding:11px 14px;font-size:14px;outline:none;background:var(--cream);font-family:'DM Sans',sans-serif;color:var(--dark);}
.find-input:focus{border-color:var(--gold2);}
.find-btn{background:linear-gradient(135deg,#9A7B0A,#C9A84C);color:#fff;border:none;border-radius:10px;padding:11px 18px;font-size:13px;font-weight:700;cursor:pointer;letter-spacing:.5px;font-family:'DM Sans',sans-serif;}
.quick-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.qbtn{background:#fff;border:1px solid var(--border);border-radius:14px;padding:18px 14px;cursor:pointer;text-align:left;font-family:'DM Sans',sans-serif;box-shadow:var(--shadow);transition:transform .1s;}
.qbtn:active{transform:scale(.97);}
.qbtn-icon{font-size:22px;margin-bottom:8px;display:block;}
.qbtn-title{font-size:14px;font-weight:600;color:var(--dark);margin-bottom:2px;}
.qbtn-sub{font-size:11px;color:var(--muted);}

/* BOTTOM NAV */
.bottom-nav{background:#fff;border-top:1px solid var(--border);display:flex;flex-shrink:0;}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:9px 2px;background:none;border:none;cursor:pointer;color:var(--muted);gap:2px;font-family:'DM Sans',sans-serif;transition:color .15s;position:relative;}
.nav-btn.active{color:var(--gold2);}
.nav-btn.active::after{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:24px;height:2px;background:var(--gold2);border-radius:0 0 3px 3px;}
.nav-icon{font-size:18px;line-height:1;}
.nav-label{font-size:9px;font-weight:500;letter-spacing:.2px;}

/* PAGE HEADER */
.page-hdr{padding:14px 16px 10px;background:#fff;border-bottom:1px solid var(--border);}
.page-hdr-label{font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.page-title{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:700;color:var(--dark);margin-top:2px;}
.scr-pad{padding:14px 14px;}

/* CARDS */
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:10px;border:1px solid var(--border);box-shadow:var(--shadow);}

/* FORMS */
.fl{font-size:10px;color:var(--muted);letter-spacing:1.2px;text-transform:uppercase;margin-bottom:5px;margin-top:12px;display:block;font-weight:600;}
.fi{width:100%;border:1.5px solid var(--border);border-radius:10px;padding:11px 14px;font-size:14px;outline:none;background:var(--cream);font-family:'DM Sans',sans-serif;color:var(--dark);transition:border .2s;}
.fi:focus{border-color:var(--gold2);}
select.fi{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%239C8E72' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;}
textarea.fi{resize:vertical;min-height:64px;}
.fi-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}

/* BUTTONS */
.btn-gold{background:linear-gradient(135deg,#9A7B0A,#C9A84C);color:#fff;border:none;border-radius:12px;padding:14px;font-size:14px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;letter-spacing:.5px;width:100%;transition:opacity .15s,transform .1s;}
.btn-gold:active{transform:scale(.98);}
.btn-gold:disabled{opacity:.45;}
.btn-whatsapp{background:#25A244;color:#fff;border:none;border-radius:12px;padding:14px;font-size:14px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;width:100%;margin-top:10px;}
.btn-outline{background:none;border:1.5px solid var(--border);color:var(--dark);border-radius:10px;padding:9px 14px;font-size:12px;font-weight:500;cursor:pointer;font-family:'DM Sans',sans-serif;}
.btn-danger{background:none;border:1.5px solid #FECACA;color:var(--red);border-radius:10px;padding:9px 14px;font-size:12px;font-weight:500;cursor:pointer;font-family:'DM Sans',sans-serif;}

/* INVENTORY */
.inv-item{background:#fff;border-radius:12px;padding:12px;margin-bottom:8px;border:1px solid var(--border);display:flex;gap:10px;align-items:flex-start;}
.inv-photo{width:66px;height:66px;border-radius:8px;object-fit:cover;border:1px solid var(--border);flex-shrink:0;}
.inv-no-photo{width:66px;height:66px;border-radius:8px;background:var(--cream2);border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:22px;}
.inv-body{flex:1;min-width:0;}
.inv-tag{font-size:12px;color:var(--gold2);font-weight:600;}
.inv-name{font-size:14px;font-weight:600;color:var(--dark);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.inv-meta{font-size:11px;color:var(--muted);margin-top:1px;}
.inv-price{font-family:'Cormorant Garamond',serif;font-size:16px;font-weight:700;color:var(--gold2);flex-shrink:0;text-align:right;}

/* CHIPS */
.chips{display:flex;gap:6px;overflow-x:auto;padding-bottom:2px;scrollbar-width:none;margin-bottom:12px;}
.chips::-webkit-scrollbar{display:none;}
.chip{background:#fff;border:1.5px solid var(--border);border-radius:20px;padding:5px 14px;font-size:11px;cursor:pointer;white-space:nowrap;color:var(--mid);font-family:'DM Sans',sans-serif;flex-shrink:0;font-weight:500;}
.chip.active{background:var(--dark);color:#fff;border-color:var(--dark);}

/* AUTOCOMPLETE */
.ac-wrap{position:relative;}
.ac-drop{position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border-radius:12px;border:1px solid var(--border);z-index:300;box-shadow:var(--shadow2);max-height:260px;overflow-y:auto;display:none;}
.ac-drop.open{display:block;}
.ac-item{padding:11px 14px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.ac-item:last-child{border-bottom:none;}
.ac-item:active{background:var(--gold-bg);}
.ac-thumb{width:36px;height:36px;border-radius:6px;object-fit:cover;flex-shrink:0;border:1px solid var(--border);}
.ac-tag{font-weight:700;color:var(--gold2);font-size:13px;}
.ac-name{color:var(--muted);font-size:12px;}

/* PRICE BREAKDOWN */
.bd-wrap{background:#fff;border-radius:14px;overflow:hidden;margin-bottom:12px;border:1px solid var(--border);}
.bd-header{padding:14px 18px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);}
.bd-cat-row{display:flex;align-items:center;gap:10px;}
.bd-cat-icon{width:28px;height:28px;border-radius:50%;background:var(--gold-bg);border:1.5px solid var(--gold-border);display:flex;align-items:center;justify-content:center;font-size:13px;}
.bd-cat-name{font-size:14px;font-weight:700;color:var(--dark);letter-spacing:.5px;}
.bd-karat{background:var(--gold-bg);border:1px solid var(--gold-border);color:var(--gold2);font-size:11px;font-weight:600;padding:4px 10px;border-radius:20px;}
.bd-row{display:flex;justify-content:space-between;align-items:flex-start;padding:13px 18px;border-bottom:1px solid #F4EFE0;}
.bd-label{font-size:14px;color:var(--dark);}
.bd-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.bd-val{font-size:14px;color:var(--dark);font-weight:500;text-align:right;}
.bd-total{background:linear-gradient(135deg,#9A7B0A,#C9A84C);padding:18px 20px;display:flex;justify-content:space-between;align-items:center;}
.bd-total-label{font-size:11px;color:rgba(255,255,255,.75);letter-spacing:2px;text-transform:uppercase;font-weight:600;}
.bd-total-val{font-family:'Cormorant Garamond',serif;font-size:30px;font-weight:700;color:#fff;}

/* BILL */
.bill-header-box{background:var(--gold-bg);padding:22px 16px;text-align:center;margin-bottom:0;border-bottom:1px solid var(--gold-border);}
.bill-header-brand{font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:700;color:var(--dark);letter-spacing:.5px;}
.bill-header-sub{font-size:10px;color:var(--gold2);letter-spacing:2px;margin:3px 0;}
.bill-header-date{font-size:12px;color:var(--muted);margin-top:6px;}
.bill-no-items{text-align:center;padding:24px;font-size:13px;color:var(--muted);}
.bill-item-row{background:#fff;border-radius:10px;padding:11px 12px;margin-bottom:6px;border:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.bill-item-name{font-size:13px;font-weight:600;color:var(--dark);}
.bill-item-meta{font-size:11px;color:var(--muted);}
.bill-item-price{font-family:'Cormorant Garamond',serif;font-size:15px;font-weight:700;color:var(--gold2);}
.bill-item-del{background:none;border:none;color:#ccc;font-size:22px;cursor:pointer;padding:0 4px;line-height:1;}
.disc-section{background:#fff;border-radius:0;padding:16px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);}
.disc-title{font-size:10px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;font-weight:600;margin-bottom:12px;}
.disc-pct-row{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.disc-pct-label{font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;font-weight:600;flex-shrink:0;}
.disc-pct-input{border:1.5px solid var(--border);border-radius:8px;padding:8px 12px;font-size:14px;width:100%;outline:none;background:var(--cream);font-family:'DM Sans',sans-serif;}
.disc-pct-input:focus{border-color:var(--gold2);}
.disc-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;font-size:13px;}
.disc-applied{color:var(--gold2);font-weight:600;}
.grand-row{background:var(--gold-bg);padding:16px;display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--gold-border);border-bottom:1px solid var(--gold-border);}
.gt-label{font-size:11px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;font-weight:700;}
.gt-val{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:700;color:var(--dark);}

/* REPORTS */
.reports-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;}
.rstat{background:#fff;border-radius:12px;padding:14px;border:1px solid var(--border);}
.rstat-icon{font-size:18px;margin-bottom:6px;}
.rstat-label{font-size:9px;color:var(--muted);letter-spacing:1.2px;text-transform:uppercase;font-weight:600;margin-bottom:4px;}
.rstat-val{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--dark);}
.rstat-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.r-inv-bar{background:var(--gold-bg);border:1px solid var(--gold-border);border-radius:12px;padding:14px 16px;margin-bottom:10px;}
.r-inv-label{font-size:10px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;font-weight:600;margin-bottom:4px;}
.r-inv-val{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;color:var(--dark);}
.r-inv-sub{font-size:11px;color:var(--muted);margin-top:3px;}
.r-section-hdr{display:flex;align-items:center;gap:8px;margin:14px 0 8px;font-size:14px;font-weight:700;color:var(--dark);}
.r-cat-row{background:#fff;border-radius:10px;padding:12px 14px;margin-bottom:6px;border:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.r-cat-icon{width:28px;height:28px;border-radius:50%;background:var(--gold-bg);border:1px solid var(--gold-border);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.r-cat-name{font-size:13px;font-weight:600;color:var(--dark);}
.r-cat-sub{font-size:11px;color:var(--muted);}
.r-cat-count{font-size:13px;font-weight:700;color:var(--gold2);}
.period-btn{background:#fff;border:1.5px solid var(--border);border-radius:20px;padding:5px 14px;font-size:11px;cursor:pointer;color:var(--mid);font-family:'DM Sans',sans-serif;font-weight:500;}
.period-btn.active{background:var(--dark);color:#fff;border-color:var(--dark);}

/* SALE RECORD CARD */
.sale-card{background:#fff;border-radius:12px;padding:14px;margin-bottom:10px;border:1px solid var(--border);box-shadow:var(--shadow);}
.sale-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.sale-item-row{background:var(--cream);border-radius:8px;padding:9px 11px;margin-bottom:5px;border:1px solid var(--border);}
.sale-item-charges{font-size:11px;color:var(--muted);margin-top:3px;}

/* ADD FORM */
.form-page-hdr{padding:12px 16px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;}
.back-circle{width:32px;height:32px;border-radius:50%;background:var(--gold-bg);border:1.5px solid var(--gold-border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;color:var(--gold2);flex-shrink:0;}
.form-hdr-label{font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;}
.form-hdr-title{font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:700;color:var(--dark);}
.photo-tap{border:2px dashed var(--border);border-radius:10px;padding:28px 16px;text-align:center;cursor:pointer;color:var(--muted);font-size:13px;background:var(--cream);}
.photo-tap-icon{font-size:24px;margin-bottom:4px;}
.nw-info{background:var(--gold-bg);border-radius:8px;padding:10px 12px;font-size:13px;color:var(--mid);margin:6px 0 2px;border:1px solid var(--gold-border);}

/* LOOKUP */
.lookup-card{background:#fff;border-radius:14px;padding:16px;border:1px solid var(--border);}

/* CUSTOMER VIEW */
#customer-view{display:none;position:fixed;inset:0;background:#fff;z-index:500;overflow-y:auto;flex-direction:column;}
#customer-view.open{display:flex;}
.cv-top{background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:10;}
.cv-back{width:32px;height:32px;border-radius:50%;background:var(--gold-bg);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;color:var(--gold2);}
.cv-body{padding:16px;}
.cv-img{width:100%;max-height:250px;object-fit:cover;border-radius:14px;margin-bottom:16px;border:1px solid var(--border);}

/* NOTIFICATION */
.notif{position:fixed;top:68px;left:50%;transform:translateX(-50%) translateY(-16px);background:var(--dark);color:#fff;padding:9px 20px;border-radius:100px;font-size:13px;font-weight:500;z-index:9999;opacity:0;transition:all .25s;pointer-events:none;white-space:nowrap;}
.notif.show{opacity:1;transform:translateX(-50%) translateY(0);}
.notif.err{background:var(--red);}
.notif.ok{background:var(--green);}

/* OWNER SWITCH MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:800;display:none;align-items:flex-end;justify-content:center;}
.modal-bg.open{display:flex;}
.modal-box{background:#fff;border-radius:20px 20px 0 0;padding:28px 24px;width:100%;max-width:480px;}
.modal-title{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--dark);margin-bottom:6px;}
.modal-sub{font-size:13px;color:var(--muted);margin-bottom:18px;}

/* MISC */
.flex-between{display:flex;justify-content:space-between;align-items:center;}
.mt8{margin-top:8px;}
.mt12{margin-top:12px;}
.mt16{margin-top:16px;}
.empty-state{text-align:center;padding:40px 20px;color:var(--muted);}
.empty-icon{font-size:40px;margin-bottom:10px;opacity:.4;}
.access-denied{text-align:center;padding:60px 24px;}
.denied-icon{font-size:48px;margin-bottom:14px;}
.denied-title{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--dark);margin-bottom:8px;}
.denied-text{font-size:13px;color:var(--muted);line-height:1.6;margin-bottom:24px;}
.gold-sep{height:1px;background:linear-gradient(90deg,transparent,var(--gold-border),transparent);margin:14px 0;}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="load-ring"></div>
  <div class="load-name">Gayatri Jewellers</div>
</div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-logo">‚ú¶</div>
  <div class="login-brand">Gayatri Jewellers</div>
  <div class="login-sub">PURITY ¬∑ ELEGANCE ¬∑ TRUST</div>
  <div class="login-card">
    <span class="lbl">Enter Access Code</span>
    <input class="linput" type="password" id="pass-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off"/>
    <div class="lerr" id="err-text"></div>
    <button class="lbtn" onclick="doLogin()">ENTER</button>
  </div>
</div>

<!-- SWITCH TO OWNER MODAL -->
<div class="modal-bg" id="owner-modal">
  <div class="modal-box">
    <div class="modal-title">Switch to Owner Mode</div>
    <div class="modal-sub">Enter the owner password to unlock owner features.</div>
    <span class="lbl">Owner Password</span>
    <input class="linput" style="font-size:16px;letter-spacing:4px;" type="password" id="owner-modal-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off"/>
    <div class="lerr" id="owner-modal-err"></div>
    <button class="lbtn" style="margin-top:12px;" onclick="submitOwnerSwitch()">CONFIRM</button>
    <button onclick="closeOwnerModal()" style="width:100%;background:none;border:none;margin-top:10px;font-size:13px;color:var(--muted);cursor:pointer;padding:6px;">Cancel</button>
  </div>
</div>

<!-- APP SHELL -->
<div id="app-shell">
  <div class="top-bar">
    <div>
      <div class="tb-brand-name">Gayatri Jewellers</div>
      <div class="tb-brand-sub">PURITY ¬∑ ELEGANCE ¬∑ TRUST</div>
      <div class="tb-date" id="tb-date"></div>
    </div>
    <div class="tb-right">
      <button id="mode-badge" onclick="onModeBadgeClick()"></button>
      <button class="exit-btn2" onclick="doLogout()">Exit</button>
    </div>
  </div>

  <div class="main-scroll" id="main-scroll">
    <!-- HOME -->
    <div class="screen active" id="screen-home">
      <div class="home-pad" id="home-content"></div>
    </div>
    <!-- LOOKUP -->
    <div class="screen" id="screen-lookup">
      <div class="page-hdr">
        <div class="page-hdr-label">Search</div>
        <div class="page-title">Tag Lookup</div>
      </div>
      <div class="scr-pad">
        <div class="ac-wrap">
          <input class="fi" id="lookup-input" placeholder="Type tag e.g. RGS-01-12‚Ä¶" oninput="lookupAC()" autocomplete="off"/>
          <div class="ac-drop" id="lookup-drop"></div>
        </div>
        <div id="lookup-result" class="mt12"></div>
      </div>
    </div>
    <!-- BILL -->
    <div class="screen" id="screen-bill">
      <div id="bill-content"></div>
    </div>
    <!-- INVENTORY -->
    <div class="screen" id="screen-inventory">
      <div id="inventory-content"></div>
    </div>
    <!-- REPORTS -->
    <div class="screen" id="screen-reports">
      <div class="page-hdr">
        <div class="page-hdr-label">PURITY ¬∑ ELEGANCE ¬∑ TRUST</div>
        <div class="page-title">Reports</div>
      </div>
      <div class="scr-pad" id="reports-content"></div>
    </div>
    <!-- ADD/EDIT -->
    <div class="screen" id="screen-add-item">
      <div id="add-item-content"></div>
    </div>
  </div>

  <div class="bottom-nav" id="bottom-nav"></div>
</div>

<!-- CUSTOMER PRICE BREAKDOWN -->
<div id="customer-view">
  <div class="cv-top">
    <button class="cv-back" onclick="closeCustomerView()">‚Üê</button>
    <div>
      <div style="font-size:12px;color:var(--gold2);font-weight:600;" id="cv-tag"></div>
      <div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:700;color:var(--dark);" id="cv-name"></div>
    </div>
  </div>
  <div class="cv-body" id="cv-body"></div>
</div>

<!-- NOTIFICATION -->
<div class="notif" id="notif"></div>

<script>
// ‚ïê‚ïê CONSTANTS ‚ïê‚ïê
const OWNER_PASS="GJISKING001";
const STAFF_PASS="GJ888826";
const CATS=["Ring","Earrings","Baliyan","Necklace","Chain","Bracelet","Bangle","Pendant","Mangalsutra","Anklet","Nosering","Set","Other"];
const TYPES=["22kt Plain","22kt Stone","18kt Diamond","14kt Diamond"];
const TYPE_LABELS={"22kt Plain":"Plain Gold","22kt Stone":"Stone Gold","18kt Diamond":"18K Diamond","14kt Diamond":"14K Diamond"};
const PURITY_LABELS={"22kt Plain":"22 Karat Gold","22kt Stone":"22 Karat Gold","18kt Diamond":"18 Karat Gold","14kt Diamond":"14 Karat Gold"};
const PERIODS=["daily","weekly","monthly","quarterly","yearly"];
const PERIOD_LABELS={"daily":"Daily","weekly":"Weekly","monthly":"Monthly","quarterly":"Quarterly","yearly":"Yearly"};
const CAT_ICONS={Ring:"üíç",Earrings:"‚ú®",Baliyan:"üîî",Necklace:"üìø",Chain:"‚õì",Bracelet:"üîó",Bangle:"üîÑ",Pendant:"üèÖ",Mangalsutra:"üü§",Anklet:"ü¶∂",Nosering:"‚≠ï",Set:"üëë",Other:"‚ú¶"};

// ‚ïê‚ïê STATE ‚ïê‚ïê
let mode=null;
let currentScreen="home";
let inventory={},rates={gold24:0,silver:0},sales={};
let editingKey=null,billingCart=[],discountPct=0,reportPeriod="daily",billDone=null;
let firebaseOk=false;
let _bc='',_bp='',_bstaff='';

// ‚ïê‚ïê FIREBASE ‚ïê‚ïê
function initFirebase(){
  if(!window._firebaseReady){document.addEventListener('firebase-ready',()=>{firebaseOk=true;listenData();});}
  else{firebaseOk=true;listenData();}
}
function listenData(){
  if(!window._db)return;
  window._onValue(window._ref(window._db,'inventory'),s=>{
    inventory=s.val()||{};
    if(currentScreen==='home')renderHome();
    if(currentScreen==='inventory')renderInventoryList();
    if(currentScreen==='reports')renderReports();
  });
  window._onValue(window._ref(window._db,'rates'),s=>{
    rates=s.val()||{gold24:0,silver:0};
    if(currentScreen==='home')renderHome();
    if(currentScreen==='inventory')renderInventoryList();
    if(currentScreen==='reports')renderReports();
  });
  window._onValue(window._ref(window._db,'sales'),s=>{
    sales=s.val()||{};
    if(currentScreen==='reports')renderReports();
    if(currentScreen==='home')renderHome();
  });
}
function dbSet(p,v){return window._set(window._ref(window._db,p),v);}
function dbPush(p,v){return window._push(window._ref(window._db,p),v);}
function dbRemove(p){return window._remove(window._ref(window._db,p));}

// ‚ïê‚ïê HELPERS ‚ïê‚ïê
function inr(n){return '‚Çπ'+Number(n||0).toLocaleString('en-IN',{maximumFractionDigits:2});}
function calcRates(g24){return{r24:g24,r22:+(g24*.945).toFixed(2),r18:+(g24*.785).toFixed(2),r14:+(g24*.62).toFixed(2)};}
function ctToG(ct){return +((ct||0)*.2).toFixed(4);}
function calcNW(gw,dCt,sCt){return +(gw-ctToG(dCt)-ctToG(sCt)).toFixed(4);}

// ‚îÄ‚îÄ FIXED calcPrice: 22kt Stone polish & NW on net weight ‚îÄ‚îÄ
function calcPrice(item){
  if(!rates.gold24)return null;
  const r=calcRates(rates.gold24);
  const gw=parseFloat(item.gw)||0;
  const polish=parseFloat(item.polishPct)||0;
  const mkPG=parseFloat(item.makingPG)||0;
  const stChg=parseFloat(item.stoneChg)||0;
  const dChg=parseFloat(item.diamondChg)||0;
  const dCt=parseFloat(item.diamondCt)||0;
  const sCt=parseFloat(item.stoneCt)||0;
  let goldRate,baseW,nw;
  if(item.type==="22kt Plain"){
    goldRate=r.r22; nw=gw; baseW=gw;
  } else if(item.type==="22kt Stone"){
    goldRate=r.r22;
    nw=Math.max(0,+(gw-ctToG(sCt)).toFixed(4));
    baseW=nw; // polish on net weight
  } else if(item.type==="18kt Diamond"){
    goldRate=r.r18;
    nw=Math.max(0,calcNW(gw,dCt,sCt));
    baseW=nw;
  } else {
    goldRate=r.r14;
    nw=Math.max(0,calcNW(gw,dCt,sCt));
    baseW=nw;
  }
  const polishW=+(baseW*polish/100).toFixed(3);
  const billW=+(baseW+polishW).toFixed(3);
  const goldVal=+(billW*goldRate).toFixed(2);
  const making=+(gw*mkPG).toFixed(2); // making always on gross weight
  let stoneVal=0,diamVal=0;
  if(item.type==="22kt Stone") stoneVal=+(ctToG(sCt)*stChg).toFixed(2);
  if(item.type==="18kt Diamond"||item.type==="14kt Diamond"){
    diamVal=+(dCt*dChg).toFixed(2);
    if(sCt>0) stoneVal=+(sCt*stChg).toFixed(2);
  }
  return{
    goldVal,making,stoneVal,diamVal,
    total:+(goldVal+making+stoneVal+diamVal).toFixed(2),
    goldRate,billW,baseW,polishW,polishPct:polish,
    gw,nw,dCt,sCt,dChg,stChg,mkPG
  };
}

// ‚îÄ‚îÄ Breakdown rows builder: making charges ALWAYS LAST ‚îÄ‚îÄ
function calcBreakdownRows(item,p){
  const isSt=item.type==='22kt Stone';
  const isDia=item.type==='18kt Diamond'||item.type==='14kt Diamond';
  const karat=item.type.startsWith('22')?'22KT':item.type.startsWith('18')?'18KT':'14KT';
  let rows=[];
  // 1. Gold Rate
  rows.push({label:`${karat} Gold Rate`,sub:'per gram',val:`${inr(p.goldRate)}/g`});
  // 2. Gross Weight (always shown)
  rows.push({label:'Gross Weight',sub:'',val:`${parseFloat(p.gw).toFixed(3)} g`});
  // 3. For stone: stone weight then net weight
  if(isSt && p.sCt>0){
    rows.push({label:'Stone Weight',sub:`${p.sCt} ct`,val:`${ctToG(p.sCt).toFixed(3)} g`});
    rows.push({label:'Net Weight',sub:'GW ‚àí Stone Weight',val:`${parseFloat(p.nw).toFixed(3)} g`});
  }
  // 3. For diamond: diamond wt, stone wt, net weight
  if(isDia){
    if(p.dCt>0) rows.push({label:'Diamond Weight',sub:`${p.dCt} ct`,val:`${ctToG(p.dCt).toFixed(3)} g`});
    if(p.sCt>0) rows.push({label:'Stone Weight',sub:`${p.sCt} ct`,val:`${ctToG(p.sCt).toFixed(3)} g`});
    rows.push({label:'Net Weight',sub:'GW ‚àí Diamond ‚àí Stone',val:`${parseFloat(p.nw).toFixed(3)} g`});
  }
  // 4. Polish on net weight
  if(p.polishPct>0){
    rows.push({label:`Polish (${p.polishPct}%)`,sub:`on Net Wt ${parseFloat(p.baseW).toFixed(3)}g`,val:`+ ${p.polishW.toFixed(3)} g`});
    rows.push({label:'Billable Gold Weight',sub:'Net Wt + Polish',val:`${p.billW.toFixed(3)} g`});
  }
  // 5. Gold value
  rows.push({label:'Gold Value',sub:`${p.billW.toFixed(3)}g √ó ${inr(p.goldRate)}/g`,val:inr(p.goldVal)});
  // 6. Stone / diamond charges
  if(isSt && p.stoneVal>0){
    rows.push({label:'Stone Charges',sub:`${ctToG(p.sCt).toFixed(4)}g √ó ${inr(p.stChg)}/g`,val:inr(p.stoneVal)});
  }
  if(isDia){
    if(p.diamVal>0) rows.push({label:'Diamond Charges',sub:`${p.dCt}ct √ó ${inr(p.dChg)}/ct`,val:inr(p.diamVal)});
    if(p.stoneVal>0) rows.push({label:'Stone Charges',sub:`${p.sCt}ct √ó ${inr(p.stChg)}/ct`,val:inr(p.stoneVal)});
  }
  // 7. Making Charges ‚Äî ALWAYS LAST
  if(p.making>0){
    rows.push({label:'Making Charges',sub:`${p.gw}g √ó ${inr(p.mkPG)}/g`,val:inr(p.making)});
  }
  return rows;
}

function notify(msg,type='ok'){
  const el=document.getElementById('notif');
  el.textContent=msg; el.className='notif '+type;
  el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2800);
}

// ‚ïê‚ïê AUTH ‚ïê‚ïê
document.getElementById('pass-input').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
document.getElementById('owner-modal-pass').addEventListener('keydown',e=>{if(e.key==='Enter')submitOwnerSwitch();});

function doLogin(){
  const p=document.getElementById('pass-input').value.trim();
  if(p===OWNER_PASS){mode='owner';startApp();}
  else if(p===STAFF_PASS){mode='staff';startApp();}
  else{document.getElementById('err-text').textContent='Incorrect password.';document.getElementById('pass-input').value='';}
}
function startApp(){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app-shell').style.display='flex';
  // Set current date
  document.getElementById('tb-date').textContent=new Date().toLocaleDateString('en-IN',{weekday:'short',day:'numeric',month:'short',year:'numeric'});
  updateModeBadge(); buildNav(); goScreen('home');
}
function doLogout(){
  mode=null;
  document.getElementById('app-shell').style.display='none';
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('pass-input').value='';
  document.getElementById('err-text').textContent='';
  billingCart=[]; billDone=null; _bc=''; _bp=''; _bstaff=''; discountPct=0;
}
function updateModeBadge(){
  const b=document.getElementById('mode-badge');
  if(mode==='owner'){b.className='owner-badge';b.textContent='‚¶ø Owner';}
  else{b.className='staff-badge';b.textContent='‚¶ø Staff';}
}

// Badge click
function onModeBadgeClick(){
  if(mode==='owner'){
    mode='staff'; updateModeBadge(); buildNav();
    if(['inventory','reports','add-item'].includes(currentScreen))goScreen('home');
    notify('Switched to Staff mode');
  } else {
    openOwnerModal();
  }
}
function openOwnerModal(){
  document.getElementById('owner-modal-pass').value='';
  document.getElementById('owner-modal-err').textContent='';
  document.getElementById('owner-modal').classList.add('open');
  setTimeout(()=>document.getElementById('owner-modal-pass').focus(),120);
}
function closeOwnerModal(){document.getElementById('owner-modal').classList.remove('open');}
function submitOwnerSwitch(){
  const p=document.getElementById('owner-modal-pass').value.trim();
  if(p===OWNER_PASS){
    closeOwnerModal(); mode='owner'; updateModeBadge(); buildNav();
    notify('Switched to Owner mode'); goScreen('home');
  } else {
    document.getElementById('owner-modal-err').textContent='Wrong owner password.';
    document.getElementById('owner-modal-pass').value='';
  }
}

// ‚ïê‚ïê NAV ‚ïê‚ïê
function buildNav(){
  const all=[
    {id:'home',label:'HOME',icon:'üè†'},
    {id:'inventory',label:'STOCK',icon:'üì¶',ow:true},
    {id:'add-item',label:'ADD',icon:'‚ûï',ow:true},
    {id:'bill',label:'BILL',icon:'üßæ'},
    {id:'reports',label:'REPORTS',icon:'üìä',ow:true},
  ];
  const visible=all.filter(n=>!n.ow||mode==='owner');
  document.getElementById('bottom-nav').innerHTML=visible.map(n=>
    `<button class="nav-btn${currentScreen===n.id?' active':''}" id="nav-${n.id}" onclick="${n.id==='add-item'?'goAddItem(null)':("goScreen('"+n.id+"')")}">
      <span class="nav-icon">${n.icon}</span>
      <span class="nav-label">${n.label}</span>
    </button>`
  ).join('');
}

function goScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('screen-'+id)?.classList.add('active');
  document.getElementById('nav-'+id)?.classList.add('active');
  currentScreen=id;
  document.getElementById('main-scroll').scrollTop=0;
  if(id==='home')renderHome();
  if(id==='lookup'){document.getElementById('lookup-input').value='';document.getElementById('lookup-result').innerHTML='';document.getElementById('lookup-drop').classList.remove('open');}
  if(id==='bill')renderBill();
  if(id==='inventory'){if(mode!=='owner'){renderDenied('inventory-content');return;}renderInventoryList();}
  if(id==='reports'){if(mode!=='owner'){renderDenied('reports-content');return;}renderReports();}
}
function renderDenied(cid){
  document.getElementById(cid).innerHTML=`<div class="access-denied"><div class="denied-icon">üîí</div><h3 class="denied-title">Owner Access Only</h3><p class="denied-text">Tap the Staff badge at the top and enter the owner password to access this section.</p><button class="btn-outline" onclick="goScreen('home')" style="margin-top:4px;">Go Home</button></div>`;
}

// ‚ïê‚ïê HOME ‚ïê‚ïê
function renderHome(){
  let html='';
  if(mode==='owner'){
    html+=`
    <div class="rate-card">
      <div><div class="rate-label">24KT GOLD RATE</div><div class="rate-value">${rates.gold24>0?inr(rates.gold24):'‚Äî'}</div><div class="rate-sub">per gram ¬∑ today</div></div>
      <input class="rate-input-box" type="number" id="h-g24" value="${rates.gold24||''}" placeholder="0" onchange="saveHomeRates()"/>
    </div>
    <div class="rate-card">
      <div><div class="rate-label">SILVER RATE</div><div class="rate-value">${rates.silver>0?inr(rates.silver):'‚Äî'}</div><div class="rate-sub">per gram</div></div>
      <input class="rate-input-box" type="number" id="h-silv" value="${rates.silver||''}" placeholder="0" onchange="saveHomeRates()"/>
    </div>`;
  } else if(rates.gold24>0){
    html+=`
    <div class="rate-card"><div><div class="rate-label">24KT GOLD RATE</div><div class="rate-value">${inr(rates.gold24)}</div><div class="rate-sub">per gram ¬∑ today</div></div></div>
    <div class="rate-card"><div><div class="rate-label">SILVER RATE</div><div class="rate-value">${rates.silver>0?inr(rates.silver):'‚Äî'}</div><div class="rate-sub">per gram</div></div></div>`;
  }
  html+=`
  <div class="find-card">
    <div class="find-label">FIND BY TAG NUMBER</div>
    <div class="find-row ac-wrap" style="position:relative;">
      <input class="find-input" id="home-find" placeholder="Type tag e.g. RGS‚Ä¶" oninput="homeFindAC()" autocomplete="off"/>
      <div class="ac-drop" id="home-find-drop"></div>
      <button class="find-btn" onclick="homeFindGo()">FIND</button>
    </div>
  </div>`;
  const acts=mode==='owner'?[
    {ic:'‚ûï',t:'Add Item',s:'Register new jewellery',fn:"goAddItem(null)"},
    {ic:'üì¶',t:'Inventory',s:'Browse & search stock',fn:"goScreen('inventory')"},
    {ic:'üßæ',t:'Create Bill',s:'Invoice with discount',fn:"goScreen('bill')"},
    {ic:'üîç',t:'Tag Lookup',s:'Find by tag number',fn:"goScreen('lookup')"},
    {ic:'üìä',t:'Reports',s:'Sales & stock report',fn:"goScreen('reports')"},
  ]:[
    {ic:'üßæ',t:'Create Bill',s:'Invoice with discount',fn:"goScreen('bill')"},
    {ic:'üîç',t:'Tag Lookup',s:'Find & add to bill',fn:"goScreen('lookup')"},
  ];
  html+=`<div class="quick-grid">${acts.map(a=>`<button class="qbtn" onclick="${a.fn}"><span class="qbtn-icon">${a.ic}</span><div class="qbtn-title">${a.t}</div><div class="qbtn-sub">${a.s}</div></button>`).join('')}</div>`;
  document.getElementById('home-content').innerHTML=html;
}
function saveHomeRates(){
  const g=parseFloat(document.getElementById('h-g24')?.value)||0;
  const s=parseFloat(document.getElementById('h-silv')?.value)||0;
  if(g>0)dbSet('rates',{gold24:g,silver:s}).then(()=>notify('Rates updated!'));
}
function homeFindAC(){
  const q=(document.getElementById('home-find')?.value||'').trim().toLowerCase();
  const drop=document.getElementById('home-find-drop');
  if(!drop)return;
  if(q.length<2){drop.classList.remove('open');return;}
  const matches=Object.entries(inventory).filter(([k,i])=>i.tag.toLowerCase().includes(q)).slice(0,8);
  if(!matches.length){drop.classList.remove('open');return;}
  drop.innerHTML=matches.map(([k,i])=>`<div class="ac-item" onclick="homeSelectItem('${k}')">${i.photo?`<img class="ac-thumb" src="${i.photo}" alt=""/>`:''}<span class="ac-tag">${i.tag}</span><span class="ac-name">${i.name}</span></div>`).join('');
  drop.classList.add('open');
}
function homeFindGo(){
  const q=(document.getElementById('home-find')?.value||'').trim();
  if(!q)return;
  const match=Object.entries(inventory).find(([k,i])=>i.tag.toLowerCase()===q.toLowerCase());
  if(match)openCustomerView(match[0]);
  else notify('Tag not found','err');
}
function homeSelectItem(key){
  document.getElementById('home-find-drop')?.classList.remove('open');
  openCustomerView(key);
}

// ‚ïê‚ïê LOOKUP ‚ïê‚ïê
function lookupAC(){
  const q=document.getElementById('lookup-input').value.trim().toLowerCase();
  const drop=document.getElementById('lookup-drop');
  document.getElementById('lookup-result').innerHTML='';
  if(q.length<2){drop.classList.remove('open');return;}
  const matches=Object.entries(inventory).filter(([k,i])=>i.tag.toLowerCase().includes(q)).slice(0,8);
  if(!matches.length){drop.classList.remove('open');return;}
  drop.innerHTML=matches.map(([k,i])=>`<div class="ac-item" onclick="selectLookupItem('${k}')">${i.photo?`<img class="ac-thumb" src="${i.photo}" alt=""/>`:''}<span class="ac-tag">${i.tag}</span><span class="ac-name">${i.name} ¬∑ ${i.type}</span></div>`).join('');
  drop.classList.add('open');
}
function selectLookupItem(key){
  const item=inventory[key];
  document.getElementById('lookup-input').value=item.tag;
  document.getElementById('lookup-drop').classList.remove('open');
  const p=calcPrice(item);
  document.getElementById('lookup-result').innerHTML=`
  <div class="lookup-card">
    <div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:14px;">
      ${item.photo?`<img style="width:80px;height:80px;object-fit:cover;border-radius:10px;border:1px solid var(--border);" src="${item.photo}" alt=""/>`:''}
      <div style="flex:1;">
        <div style="font-size:12px;color:var(--gold2);font-weight:600;">${item.tag}</div>
        <div style="font-size:15px;font-weight:700;color:var(--dark);">${item.name}</div>
        <div style="font-size:12px;color:var(--muted);">${item.category} ¬∑ ${item.type}</div>
        <div style="font-size:12px;color:var(--mid);">GW: ${item.gw}g${item.nw&&item.nw!=item.gw?` ¬∑ NW: ${item.nw}g`:''}</div>
        ${item.notes?`<div style="font-size:11px;color:var(--muted);margin-top:3px;font-style:italic;">${item.notes}</div>`:''}
      </div>
    </div>
    ${p?`
    <div style="background:var(--gold-bg);border-radius:10px;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--gold-border);margin-bottom:10px;">
      <span style="font-size:12px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;">Total Value</span>
      <span style="font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--dark);">${inr(p.total)}</span>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <button onclick="openCustomerView('${key}')" style="background:none;border:1.5px solid var(--border);border-radius:10px;padding:10px 14px;font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;color:var(--dark);">üîç Price Breakdown</button>
      <button onclick="addToCartFromLookup('${key}')" style="background:linear-gradient(135deg,#9A7B0A,#C9A84C);border:none;border-radius:10px;padding:10px 14px;font-size:13px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;color:#fff;">üßæ Add to Bill</button>
    </div>
    `:`<div style="background:var(--gold-bg);border-radius:8px;padding:12px;text-align:center;font-size:13px;color:var(--gold2);">Rates not set. Contact owner.</div>`}
  </div>`;
}

function addToCartFromLookup(key){
  const item=inventory[key];
  if(!item){notify('Item not found','err');return;}
  if(billingCart.some(i=>i.tag===item.tag)){notify('Already in bill','err');return;}
  billingCart.push(item);
  notify('Added to bill ‚úì');
  goScreen('bill');
}

// ‚ïê‚ïê CUSTOMER VIEW (Price Breakdown) ‚ïê‚ïê
function openCustomerView(key){
  const item=inventory[key]; if(!item)return;
  const p=calcPrice(item); if(!p){notify('Rates not set','err');return;}
  window._cvKey=key;
  document.getElementById('cv-tag').textContent=item.tag;
  document.getElementById('cv-name').textContent=item.name;
  const karat=item.type.startsWith('22')?'22 Karat':item.type.startsWith('18')?'18 Karat':'14 Karat';
  const rows=calcBreakdownRows(item,p);
  const catIcon=CAT_ICONS[item.category]||'‚ú¶';
  document.getElementById('cv-body').innerHTML=`
    ${item.photo?`<img class="cv-img" src="${item.photo}" alt="${item.name}"/>`:'<div style="height:16px;"></div>'}
    <div class="bd-wrap">
      <div class="bd-header">
        <div class="bd-cat-row"><div class="bd-cat-icon">${catIcon}</div><span class="bd-cat-name">${item.category.toUpperCase()}</span></div>
        <span class="bd-karat">${karat}</span>
      </div>
      ${rows.map(r=>`<div class="bd-row"><div><div class="bd-label">${r.label}</div>${r.sub?`<div class="bd-sub">${r.sub}</div>`:''}</div><div class="bd-val">${r.val}</div></div>`).join('')}
      <div class="bd-total"><div class="bd-total-label">TOTAL VALUE</div><div class="bd-total-val">${inr(p.total)}</div></div>
    </div>
    <button class="btn-gold" onclick="addToCartFromCV()" style="margin-bottom:10px;">üßæ Add to Bill</button>
    <div style="text-align:center;padding:8px 16px 24px;font-size:11px;color:var(--muted);line-height:2;">
      <strong style="font-family:'Cormorant Garamond',serif;font-size:13px;color:var(--gold2);">Gayatri Jewellers</strong><br/>
      BIS Hallmarked ¬∑ Certified Purity ¬∑ Transparent Pricing
    </div>`;
  document.getElementById('customer-view').classList.add('open');
  document.getElementById('customer-view').scrollTop=0;
}
function addToCartFromCV(){
  if(window._cvKey)addToCartFromLookup(window._cvKey);
  closeCustomerView();
}
function closeCustomerView(){document.getElementById('customer-view').classList.remove('open');}

// ‚ïê‚ïê BILLING ‚ïê‚ïê
function renderBill(){
  if(billDone){renderBillSuccess();return;}
  const today=new Date();
  const dateStr=today.toLocaleDateString('en-IN',{day:'numeric',month:'long',year:'numeric'});
  const mkTotal=billingCart.reduce((a,i)=>{const p=calcPrice(i);return a+(p?.making||0);},0);
  const disc=Math.min(100,Math.max(0,discountPct||0));
  const discAmt=+(mkTotal*disc/100).toFixed(2);
  const cartTotal=billingCart.reduce((a,i)=>{const p=calcPrice(i);return a+(p?.total||0);},0);
  const grand=+(cartTotal-discAmt).toFixed(2);
  const cartHTML=billingCart.length===0?
    `<div class="bill-no-items">No items yet. Use Tag Lookup to find items and add to bill.</div>`:
    billingCart.map((item,idx)=>{
      const p=calcPrice(item);
      return `<div class="bill-item-row"><div><div class="bill-item-name">${item.name}</div><div class="bill-item-meta">${item.tag} ¬∑ ${item.type} ¬∑ GW:${item.gw}g</div></div><div style="display:flex;align-items:center;gap:8px;"><span class="bill-item-price">${p?inr(p.total):'‚Äî'}</span><button class="bill-item-del" onclick="removeFromCart(${idx})">√ó</button></div></div>`;
    }).join('');
  document.getElementById('bill-content').innerHTML=`
    <div class="bill-header-box">
      <div class="bill-header-brand">‚ú¶ Gayatri Jewellers</div>
      <div class="bill-header-sub">PURITY ¬∑ ELEGANCE ¬∑ TRUST</div>
      <div class="bill-header-date">${dateStr}</div>
    </div>
    <div style="padding:14px 14px 0;">
      <div class="card" style="padding:14px;margin-bottom:8px;">
        <div style="font-size:10px;color:var(--muted);letter-spacing:1.2px;text-transform:uppercase;font-weight:600;margin-bottom:10px;">CUSTOMER & STAFF DETAILS</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div><span class="fl" style="margin-top:0;">CUSTOMER NAME *</span><input class="fi" id="bill-cname" placeholder="Name" value="${_bc}" oninput="saveBillFields()"/></div>
          <div><span class="fl" style="margin-top:0;">PHONE</span><input class="fi" id="bill-phone" placeholder="Phone" value="${_bp}" oninput="saveBillFields()"/></div>
        </div>
        <div><span class="fl" style="margin-top:10px;">STAFF NAME *</span><input class="fi" id="bill-staff" placeholder="Who is serving this customer?" value="${_bstaff}" oninput="saveBillFields()"/></div>
        <div class="ac-wrap mt8">
          <input class="fi" id="bill-search" placeholder="Search tag to add items‚Ä¶" oninput="billAC()" autocomplete="off" style="margin-bottom:0;"/>
          <div class="ac-drop" id="bill-drop"></div>
        </div>
      </div>
      <div style="margin-bottom:8px;">${cartHTML}</div>
    </div>
    <div class="disc-section">
      <div class="disc-title">DISCOUNT ON MAKING CHARGES</div>
      <div class="disc-pct-row"><span class="disc-pct-label">DISCOUNT %</span><input class="disc-pct-input" type="number" id="disc-input" placeholder="0 to 100" min="0" max="100" value="${disc||''}" oninput="discountPct=parseFloat(this.value)||0;saveBillFields();renderBill();"/></div>
      <div class="disc-row"><span style="font-size:13px;color:var(--muted);">Making Charges Total</span><span style="font-size:13px;font-weight:600;color:var(--dark);">${inr(mkTotal)}</span></div>
      <div class="disc-row"><span class="disc-applied">Discount Applied</span><span style="color:var(--gold2);font-weight:600;">- ${inr(discAmt)}</span></div>
    </div>
    <div class="grand-row"><span class="gt-label">GRAND TOTAL</span><span class="gt-val">${inr(grand)}</span></div>
    <div style="padding:12px 14px 20px;">
      <button class="btn-gold" onclick="completeBill()">COMPLETE SALE & GENERATE BILL</button>
      <button class="btn-whatsapp" onclick="shareWhatsApp()">SHARE ON WHATSAPP</button>
    </div>`;
}

function saveBillFields(){
  _bc=document.getElementById('bill-cname')?.value||'';
  _bp=document.getElementById('bill-phone')?.value||'';
  _bstaff=document.getElementById('bill-staff')?.value||'';
}
function billAC(){
  saveBillFields();
  const q=document.getElementById('bill-search').value.trim().toLowerCase();
  const drop=document.getElementById('bill-drop');
  if(q.length<2){drop.classList.remove('open');return;}
  const inCart=billingCart.map(i=>i.tag);
  const matches=Object.entries(inventory).filter(([k,i])=>i.tag.toLowerCase().includes(q)&&!inCart.includes(i.tag)).slice(0,6);
  if(!matches.length){drop.classList.remove('open');return;}
  drop.innerHTML=matches.map(([k,i])=>`<div class="ac-item" onclick="addToCart('${k}')">${i.photo?`<img class="ac-thumb" src="${i.photo}" alt=""/>`:''}<span class="ac-tag">${i.tag}</span><span class="ac-name">${i.name} ¬∑ ${i.gw}g</span></div>`).join('');
  drop.classList.add('open');
}
function addToCart(key){saveBillFields();billingCart.push(inventory[key]);renderBill();}
function removeFromCart(idx){saveBillFields();billingCart.splice(idx,1);renderBill();}

function completeBill(){
  saveBillFields();
  const name=_bc.trim();
  const phone=_bp.trim();
  const staff=_bstaff.trim();
  if(!name){notify('Enter customer name','err');return;}
  if(!staff){notify('Enter staff name','err');return;}
  if(!billingCart.length){notify('Add at least one item','err');return;}
  const disc=Math.min(100,Math.max(0,discountPct||0));
  const mkTotal=billingCart.reduce((a,i)=>{const p=calcPrice(i);return a+(p?.making||0);},0);
  const discAmt=+(mkTotal*disc/100).toFixed(2);
  const cartTotal=billingCart.reduce((a,i)=>{const p=calcPrice(i);return a+(p?.total||0);},0);
  const grand=+(cartTotal-discAmt).toFixed(2);
  // Save full snapshot of each item + calculated values
  const billItems=billingCart.map(i=>{
    const p=calcPrice(i);
    return{
      tag:i.tag,name:i.name,category:i.category||'',type:i.type||'',
      gw:i.gw,nw:i.nw||i.gw,diamondCt:i.diamondCt||0,stoneCt:i.stoneCt||0,
      polishPct:i.polishPct||0,makingPG:i.makingPG||0,
      stoneChg:i.stoneChg||0,diamondChg:i.diamondChg||0,
      goldVal:p?.goldVal||0,making:p?.making||0,
      stoneVal:p?.stoneVal||0,diamVal:p?.diamVal||0,total:p?.total||0
    };
  });
  const bill={
    date:new Date().toISOString(),customer:name,phone,staff,
    items:billItems,making:mkTotal,discPct:disc,discAmt,total:grand
  };
  // Find inventory keys for sold items
  const soldKeys=Object.entries(inventory)
    .filter(([k,i])=>billingCart.some(ci=>ci.tag===i.tag))
    .map(([k])=>k);

  dbPush('sales',bill).then(()=>{
    // Remove sold items from inventory automatically
    return Promise.all(soldKeys.map(k=>dbRemove('inventory/'+k)));
  }).then(()=>{
    billDone=bill; billingCart=[]; _bc=''; _bp=''; _bstaff=''; discountPct=0;
    notify('Sale saved! Items removed from inventory.'); renderBillSuccess();
  }).catch(()=>notify('Error saving sale','err'));
}

function renderBillSuccess(){
  if(!billDone)return;
  const billNo='GJ'+new Date(billDone.date).getTime().toString().slice(-7);
  const dateStr=new Date(billDone.date).toLocaleDateString('en-IN',{day:'numeric',month:'long',year:'numeric'});
  const timeStr=new Date(billDone.date).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});

  let itemsHTML='';
  billDone.items.forEach(it=>{
    // Reconstruct item to get breakdown rows
    const fakeItem={
      type:it.type,gw:it.gw,nw:it.nw,
      diamondCt:it.diamondCt,stoneCt:it.stoneCt,
      polishPct:it.polishPct,makingPG:it.makingPG,
      stoneChg:it.stoneChg,diamondChg:it.diamondChg
    };
    const p=calcPrice(fakeItem);
    const rows=p?calcBreakdownRows(fakeItem,p):[];
    itemsHTML+=`
      <div style="background:#fff;border-radius:12px;padding:14px;margin-bottom:10px;border:1px solid var(--border);box-shadow:var(--shadow);">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;padding-bottom:8px;border-bottom:1.5px solid var(--gold-border);">
          <div>
            <div style="font-size:14px;font-weight:700;color:var(--dark);">${it.name}</div>
            <div style="font-size:11px;color:var(--gold2);font-weight:600;margin-top:2px;">${it.tag} ¬∑ ${it.category||''} ¬∑ ${it.type||''}</div>
          </div>
          <div style="font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:700;color:var(--gold2);">${inr(it.total)}</div>
        </div>
        ${rows.map(r=>`
          <div style="display:flex;justify-content:space-between;align-items:flex-start;padding:5px 0;border-bottom:1px solid #f5f0e4;">
            <div>
              <div style="font-size:12px;color:var(--dark);">${r.label}</div>
              ${r.sub?`<div style="font-size:10px;color:var(--muted);">${r.sub}</div>`:''}
            </div>
            <div style="font-size:12px;color:var(--dark);font-weight:500;text-align:right;">${r.val}</div>
          </div>`).join('')}
        <div style="display:flex;justify-content:space-between;padding:8px 0 0;font-size:13px;font-weight:700;color:var(--gold2);">
          <span>ITEM TOTAL</span><span>${inr(it.total)}</span>
        </div>
      </div>`;
  });

  document.getElementById('bill-content').innerHTML=`
    <div style="padding:0 0 30px;">
      <!-- Header -->
      <div style="background:linear-gradient(135deg,#9A7B0A,#C9A84C);padding:24px 20px;text-align:center;">
        <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;color:#fff;letter-spacing:1px;">‚ú¶ Gayatri Jewellers</div>
        <div style="font-size:10px;color:rgba(255,255,255,.8);letter-spacing:3px;margin-top:4px;">PURITY ¬∑ ELEGANCE ¬∑ TRUST</div>
        <div style="font-size:11px;color:rgba(255,255,255,.65);margin-top:5px;">BIS Hallmarked ¬∑ Certified Pure Gold</div>
      </div>

      <!-- Bill Meta -->
      <div style="background:var(--cream);padding:14px 16px;border-bottom:1px solid var(--border);">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;">
          <div>
            <div style="font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:2px;">BILL NO</div>
            <div style="font-weight:700;color:var(--dark);font-size:13px;">${billNo}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:2px;">DATE</div>
            <div style="font-weight:600;color:var(--dark);">${dateStr}</div>
            <div style="font-size:11px;color:var(--muted);">${timeStr}</div>
          </div>
          <div>
            <div style="font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:2px;">CUSTOMER</div>
            <div style="font-weight:700;color:var(--dark);">${billDone.customer}</div>
            ${billDone.phone?`<div style="font-size:11px;color:var(--muted);">${billDone.phone}</div>`:''}
          </div>
          <div style="text-align:right;">
            <div style="font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:2px;">SERVED BY</div>
            <div style="font-weight:700;color:var(--dark);">${billDone.staff||'‚Äî'}</div>
          </div>
        </div>
      </div>

      <!-- Gold Rate at time of sale -->
      <div style="background:#fff;padding:10px 16px;border-bottom:1px solid var(--border);font-size:11px;color:var(--muted);">
        24KT Gold Rate: <strong style="color:var(--dark);">${inr(rates.gold24)}/g</strong> &nbsp;|&nbsp; 22KT: <strong style="color:var(--dark);">${inr(+(rates.gold24*.945).toFixed(2))}/g</strong>
      </div>

      <!-- Items -->
      <div style="padding:14px;">
        <div style="font-size:10px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;font-weight:600;margin-bottom:10px;">ITEMS & PRICE BREAKDOWN</div>
        ${itemsHTML}
      </div>

      <!-- Totals -->
      <div style="margin:0 14px 14px;background:#fff;border-radius:12px;border:1px solid var(--border);overflow:hidden;">
        <div style="display:flex;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="color:var(--muted);">Subtotal</span>
          <span style="font-weight:600;">${inr(billDone.items.reduce((a,i)=>a+i.total,0))}</span>
        </div>
        ${billDone.discAmt>0?`
        <div style="display:flex;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="color:var(--green);">Discount on Making (${billDone.discPct}%)</span>
          <span style="color:var(--green);font-weight:600;">‚àí ${inr(billDone.discAmt)}</span>
        </div>`:''}
        <div style="display:flex;justify-content:space-between;padding:16px;background:linear-gradient(135deg,#9A7B0A,#C9A84C);">
          <span style="font-size:11px;color:rgba(255,255,255,.8);letter-spacing:2px;text-transform:uppercase;font-weight:700;align-self:center;">GRAND TOTAL</span>
          <span style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;color:#fff;">${inr(billDone.total)}</span>
        </div>
      </div>

      <!-- Footer -->
      <div style="text-align:center;padding:6px 20px 8px;font-size:11px;color:var(--muted);line-height:2;">
        Thank you for your purchase! üôè<br/>
        <strong style="color:var(--gold2);">Gayatri Jewellers</strong> ‚Äî Exchange &amp; return as per store policy
      </div>

      <!-- Actions -->
      <div style="padding:8px 14px 20px;">
        <button class="btn-gold" onclick="billDone=null;renderBill();">+ New Bill</button>
        <button class="btn-whatsapp" onclick="shareWhatsAppBill();" style="margin-top:8px;">Share on WhatsApp</button>
      </div>
    </div>`;
}

function shareWhatsApp(){
  saveBillFields();
  const name=_bc||'Customer';
  const disc=discountPct||0;
  const mkTotal=billingCart.reduce((a,i)=>{const p=calcPrice(i);return a+(p?.making||0);},0);
  const discAmt=+(mkTotal*disc/100).toFixed(2);
  const cartTotal=billingCart.reduce((a,i)=>{const p=calcPrice(i);return a+(p?.total||0);},0);
  const grand=+(cartTotal-discAmt).toFixed(2);
  let msg=`*‚ú¶ Gayatri Jewellers*\n_Purity ¬∑ Elegance ¬∑ Trust_\n\nDear ${name},\n\n`;
  billingCart.forEach(i=>{const p=calcPrice(i);msg+=`‚Ä¢ ${i.name} (${i.tag}) ‚Äî ${inr(p?.total||0)}\n`;});
  if(discAmt>0)msg+=`\nDiscount on Making: -${inr(discAmt)}`;
  msg+=`\n*Grand Total: ${inr(grand)}*\n\nThank you for shopping with us! üôè`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
}
function shareWhatsAppBill(){
  if(!billDone)return;
  const dateStr=new Date(billDone.date).toLocaleDateString('en-IN',{day:'numeric',month:'long',year:'numeric'});
  let msg=`*‚ú¶ Gayatri Jewellers*\n_Purity ¬∑ Elegance ¬∑ Trust_\n\nüìã *INVOICE*\nDate: ${dateStr}\nCustomer: *${billDone.customer}*${billDone.phone?' | '+billDone.phone:''}\nStaff: ${billDone.staff||'‚Äî'}\n\n*ITEMS PURCHASED:*\n`;
  billDone.items.forEach((it,i)=>{
    msg+=`\n${i+1}. *${it.name}* (${it.tag})\n   Type: ${it.type} | GW: ${it.gw}g\n   Gold: ${inr(it.goldVal)}${it.stoneVal>0?' | Stone: '+inr(it.stoneVal):''}${it.diamVal>0?' | Diamond: '+inr(it.diamVal):''}${it.making>0?' | Making: '+inr(it.making):''}\n   *Item Total: ${inr(it.total)}*\n`;
  });
  if(billDone.discAmt>0)msg+=`\nDiscount on Making (${billDone.discPct}%): -${inr(billDone.discAmt)}`;
  msg+=`\n\n*GRAND TOTAL: ${inr(billDone.total)}*`;
  msg+=`\n\nThank you for shopping with us! üôè\n_Gayatri Jewellers ‚Äî BIS Hallmarked Certified Gold_`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
}

// ‚ïê‚ïê INVENTORY ‚ïê‚ïê
let invSearch='',invFilter='All';
function renderInventoryList(){
  const items=Object.entries(inventory).filter(([k,i])=>{
    const ms=i.tag.toLowerCase().includes(invSearch.toLowerCase())||i.name.toLowerCase().includes(invSearch.toLowerCase());
    return ms&&(invFilter==='All'||i.type===invFilter);
  });
  document.getElementById('inventory-content').innerHTML=`
    <div class="page-hdr"><div class="flex-between"><div><div class="page-hdr-label">OWNER</div><div class="page-title">Inventory</div></div><button class="btn-gold" style="width:auto;padding:9px 18px;font-size:13px;" onclick="goAddItem(null)">+ Add</button></div></div>
    <div class="scr-pad">
      <input class="fi" placeholder="Search by tag or name‚Ä¶" oninput="invSearch=this.value;renderInventoryList()" value="${invSearch}"/>
      <div class="chips mt8">${['All',...TYPES].map(t=>`<button class="chip${invFilter===t?' active':''}" onclick="invFilter='${t}';renderInventoryList()">${t}</button>`).join('')}</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:10px;">${items.length} item${items.length!==1?'s':''}</div>
      ${items.length===0?`<div class="empty-state"><div class="empty-icon">üì¶</div><p>No items found</p></div>`:
        items.map(([k,item])=>{
          const p=calcPrice(item);
          return `<div class="inv-item">${item.photo?`<img class="inv-photo" src="${item.photo}" alt=""/>`:
            `<div class="inv-no-photo">${CAT_ICONS[item.category]||'‚ú¶'}</div>`}
            <div class="inv-body">
              <div class="inv-tag">${item.tag}</div><div class="inv-name">${item.name}</div>
              <div class="inv-meta">${item.type} ¬∑ ${item.category} ¬∑ GW:${item.gw}g${item.nw&&item.nw!=item.gw?` NW:${item.nw}g`:''}</div>
              <div style="display:flex;gap:8px;margin-top:8px;">
                <button class="btn-outline" style="flex:1;padding:7px 0;" onclick="goAddItem('${k}')">Edit</button>
                <button class="btn-danger" style="flex:1;padding:7px 0;" onclick="deleteItem('${k}','${item.name.replace(/'/g,"\\'")}')">Delete</button>
              </div>
            </div>
            ${p?`<div class="inv-price">${inr(p.total)}</div>`:''}
          </div>`;
        }).join('')}
    </div>`;
}
function deleteItem(key,name){if(!confirm('Delete "'+name+'"?'))return;dbRemove('inventory/'+key).then(()=>notify('Deleted'));}

// ‚ïê‚ïê ADD/EDIT ITEM ‚ïê‚ïê
function goAddItem(key){
  if(mode!=='owner'){notify('Owner access required','err');return;}
  editingKey=key;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('screen-add-item').classList.add('active');
  document.getElementById('nav-add-item')?.classList.add('active');
  currentScreen='add-item';
  document.getElementById('main-scroll').scrollTop=0;
  renderAddForm(key?inventory[key]:null);
}
function renderAddForm(item){
  const isEdit=!!item;
  const t=item?.type||'22kt Plain';
  const isDia=t==='18kt Diamond'||t==='14kt Diamond',isSt=t==='22kt Stone';
  const gw=parseFloat(item?.gw)||0;
  const dCt=parseFloat(item?.diamondCt)||0;
  const sCt=parseFloat(item?.stoneCt)||0;
  const stCt2=parseFloat(item?.stoneCt)||0; // for stone type
  const nwDia=isDia?calcNW(gw,dCt,sCt):gw;
  const nwSt=isSt?Math.max(0,+(gw-ctToG(stCt2)).toFixed(4)):gw;
  document.getElementById('add-item-content').innerHTML=`
    <div class="form-page-hdr">
      <button class="back-circle" onclick="goScreen('inventory')">‚Üê</button>
      <div><div class="form-hdr-label">${isEdit?'EDIT ITEM':'NEW ITEM'}</div><div class="form-hdr-title">${isEdit?'Edit Jewellery':'Add Jewellery'}</div></div>
    </div>
    <div class="scr-pad">
      <div class="card">
        <span class="fl" style="margin-top:0;">JEWELLERY TYPE *</span>
        <select class="fi" id="ai-type" onchange="onTypeChange()">
          ${TYPES.map(tp=>`<option value="${tp}"${item?.type===tp?' selected':''}>${TYPE_LABELS[tp]}</option>`).join('')}
        </select>
        <div class="fi-row">
          <div><span class="fl">TAG NUMBER *</span><input class="fi" id="ai-tag" value="${item?.tag||''}" placeholder="RGS-01-12" oninput="this.value=this.value.toUpperCase()"/></div>
          <div><span class="fl">CATEGORY</span><select class="fi" id="ai-cat">${CATS.map(c=>`<option${item?.category===c?' selected':''}>${c}</option>`).join('')}</select></div>
        </div>
        <span class="fl">ITEM NAME *</span>
        <input class="fi" id="ai-name" value="${item?.name||''}" placeholder="e.g. RING"/>
        <span class="fl">PURITY</span>
        <select class="fi" id="ai-purity" onchange="onPurityChange()">
          ${TYPES.map(tp=>`<option value="${tp}"${item?.type===tp?' selected':''}>${PURITY_LABELS[tp]}</option>`).join('')}
        </select>
        <div class="fi-row">
          <div><span class="fl">GROSS WEIGHT (G) *</span><input class="fi" type="number" id="ai-gw" value="${item?.gw||''}" placeholder="2.145" oninput="onWeightChange()"/></div>
          <div><span class="fl">POLISH %</span><input class="fi" type="number" id="ai-polish" value="${item?.polishPct??10}" placeholder="10"/></div>
        </div>
        <div id="ai-dia-fields" style="${isDia?'':'display:none;'}">
          <div class="fi-row">
            <div><span class="fl">DIAMOND WT (CT)</span><input class="fi" type="number" id="ai-dct" value="${item?.diamondCt||''}" placeholder="0.00" oninput="onWeightChange()"/></div>
            <div><span class="fl">STONE WT (CT)</span><input class="fi" type="number" id="ai-sct" value="${item?.stoneCt||''}" placeholder="0.00" oninput="onWeightChange()"/></div>
          </div>
          <div class="nw-info">Net Weight: <strong id="ai-nw-val">${nwDia}g</strong> &nbsp;(GW ‚àí Diamond ‚àí Stone)</div>
        </div>
        <div id="ai-stone-fields" style="${isSt?'':'display:none;'}">
          <span class="fl">STONE WEIGHT (CT)</span>
          <input class="fi" type="number" id="ai-sct2" value="${item?.stoneCt||''}" placeholder="0.00" oninput="onWeightChange()"/>
          <div class="nw-info" id="ai-stone-nw-info">Net Weight: <strong id="ai-stone-nw-val">${nwSt}g</strong> &nbsp;(GW ‚àí Stone Wt ¬∑ Polish on NW)</div>
        </div>
        <span class="fl">MAKING CHARGES (‚Çπ PER GRAM OF GROSS WEIGHT)</span>
        <input class="fi" type="number" id="ai-making" value="${item?.makingPG??240}" placeholder="240"/>
        <div id="ai-stchg-wrap" style="${isSt?'':'display:none;'}">
          <span class="fl">STONE CHARGES (‚Çπ/GRAM)</span>
          <input class="fi" type="number" id="ai-stchg" value="${item?.stoneChg||0}"/>
        </div>
        <div id="ai-dia-chg-wrap" style="${isDia?'':'display:none;'}">
          <span class="fl">DIAMOND CHARGES (‚Çπ/CARAT)</span>
          <input class="fi" type="number" id="ai-dchg" value="${item?.diamondChg||0}"/>
          <div id="ai-stchg2-wrap" style="${sCt>0?'':'display:none;'}">
            <span class="fl">STONE CHARGES (‚Çπ/CARAT)</span>
            <input class="fi" type="number" id="ai-stchg2" value="${item?.stoneChg||0}"/>
          </div>
        </div>
        <span class="fl">PHOTO</span>
        ${item?.photo?
          `<img src="${item.photo}" id="ai-photo-preview" style="width:90px;height:90px;object-fit:cover;border-radius:8px;border:1px solid var(--border);display:block;margin-bottom:8px;" onclick="document.getElementById('ai-file').click()"/>`:
          `<div class="photo-tap" onclick="document.getElementById('ai-file').click()"><div class="photo-tap-icon">üì∑</div>Tap to add photo</div>
           <img id="ai-photo-preview" style="width:90px;height:90px;object-fit:cover;border-radius:8px;border:1px solid var(--border);display:none;margin-top:8px;"/>`}
        <input type="file" accept="image/*" id="ai-file" style="display:none;" onchange="handlePhoto(event)"/>
        <button class="btn-gold mt16" onclick="saveItem()" style="letter-spacing:1px;">${isEdit?'UPDATE ITEM':'SAVE TO INVENTORY'}</button>
      </div>
    </div>`;
  window._photoData=item?.photo||null;
}
function onTypeChange(){const t=document.getElementById('ai-type').value;document.getElementById('ai-purity').value=t;toggleFields(t);}
function onPurityChange(){const t=document.getElementById('ai-purity').value;document.getElementById('ai-type').value=t;toggleFields(t);}
function toggleFields(t){
  const isDia=t==='18kt Diamond'||t==='14kt Diamond',isSt=t==='22kt Stone';
  document.getElementById('ai-dia-fields').style.display=isDia?'':'none';
  document.getElementById('ai-stone-fields').style.display=isSt?'':'none';
  document.getElementById('ai-stchg-wrap').style.display=isSt?'':'none';
  document.getElementById('ai-dia-chg-wrap').style.display=isDia?'':'none';
  onWeightChange();
}
function onWeightChange(){
  const t=document.getElementById('ai-type')?.value;
  const gw=parseFloat(document.getElementById('ai-gw')?.value)||0;
  if(t==='18kt Diamond'||t==='14kt Diamond'){
    const dCt=parseFloat(document.getElementById('ai-dct')?.value)||0;
    const sCt=parseFloat(document.getElementById('ai-sct')?.value)||0;
    const el=document.getElementById('ai-nw-val');
    if(el)el.textContent=calcNW(gw,dCt,sCt)+'g';
    const s2=document.getElementById('ai-stchg2-wrap');
    if(s2)s2.style.display=sCt>0?'':'none';
  }
  if(t==='22kt Stone'){
    const sCt=parseFloat(document.getElementById('ai-sct2')?.value)||0;
    const nw=Math.max(0,+(gw-ctToG(sCt)).toFixed(4));
    const el=document.getElementById('ai-stone-nw-val');
    if(el)el.textContent=nw+'g';
  }
}
function handlePhoto(e){
  const f=e.target.files[0];if(!f)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement('canvas');
      const MAX=600;let w=img.width,h=img.height;
      if(w>MAX){h=h*MAX/w;w=MAX;}if(h>MAX){w=w*MAX/h;h=MAX;}
      c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);
      const d=c.toDataURL('image/jpeg',.75);
      window._photoData=d;
      const prev=document.getElementById('ai-photo-preview');
      prev.src=d;prev.style.display='block';
      const tap=document.querySelector('.photo-tap');if(tap)tap.style.display='none';
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(f);
}
function saveItem(){
  const tag=document.getElementById('ai-tag').value.trim().toUpperCase();
  const name=document.getElementById('ai-name').value.trim();
  const gw=parseFloat(document.getElementById('ai-gw').value)||0;
  if(!tag||!name||!gw){notify('Tag, Name & Weight required','err');return;}
  // Duplicate tag check ‚Äî skip if editing the same item
  const duplicate=Object.entries(inventory).find(([k,i])=>i.tag.toUpperCase()===tag && k!==editingKey);
  if(duplicate){notify('Tag "'+tag+'" already exists in inventory!','err');return;}
  const type=document.getElementById('ai-type').value;
  const isDia=type==='18kt Diamond'||type==='14kt Diamond',isSt=type==='22kt Stone';
  const dCt=parseFloat(document.getElementById('ai-dct')?.value)||0;
  const sCt=isDia?(parseFloat(document.getElementById('ai-sct')?.value)||0):(parseFloat(document.getElementById('ai-sct2')?.value)||0);
  // Fix NW: for stone, nw = gw - stone weight
  const nw=isDia?calcNW(gw,dCt,sCt):isSt?Math.max(0,+(gw-ctToG(sCt)).toFixed(4)):gw;
  const item={
    tag,name,gw,nw,type,
    category:document.getElementById('ai-cat').value,
    diamondCt:dCt,stoneCt:sCt,
    polishPct:parseFloat(document.getElementById('ai-polish').value)||0,
    makingPG:parseFloat(document.getElementById('ai-making').value)||0,
    stoneChg:isSt?(parseFloat(document.getElementById('ai-stchg')?.value)||0):(isDia?(parseFloat(document.getElementById('ai-stchg2')?.value)||0):0),
    diamondChg:isDia?(parseFloat(document.getElementById('ai-dchg')?.value)||0):0,
    photo:window._photoData||'',notes:'',
  };
  dbSet((editingKey?'inventory/'+editingKey:'inventory/'+Date.now()),item).then(()=>{
    notify(editingKey?'Item updated!':'Item saved!');editingKey=null;goScreen('inventory');
  });
}

// ‚ïê‚ïê REPORTS ‚ïê‚ïê
function inPeriod(ds){
  const d=new Date(ds),now=new Date();
  if(reportPeriod==='daily')return d.toDateString()===now.toDateString();
  if(reportPeriod==='weekly'){const df=(now-d)/864e5;return df>=0&&df<7;}
  if(reportPeriod==='monthly')return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();
  if(reportPeriod==='quarterly')return Math.floor(d.getMonth()/3)===Math.floor(now.getMonth()/3)&&d.getFullYear()===now.getFullYear();
  return d.getFullYear()===now.getFullYear();
}

function deleteSale(key){
  if(!confirm('Delete this sale record? This action cannot be undone.'))return;
  dbRemove('sales/'+key).then(()=>notify('Sale deleted'));
}

function renderReports(){
  if(mode!=='owner'){renderDenied('reports-content');return;}
  const salesArr=Object.entries(sales); // keep [key, val] pairs
  const salesVals=salesArr.map(([k,s])=>s);
  const todayS=salesVals.filter(s=>new Date(s.date).toDateString()===new Date().toDateString());
  const todayRev=todayS.reduce((a,s)=>a+(s.total||0),0);
  const totalRev=salesVals.reduce((a,s)=>a+(s.total||0),0);
  const items=Object.values(inventory);
  const totalGw=items.reduce((a,i)=>a+(parseFloat(i.gw)||0),0);
  const totalVal=items.reduce((a,i)=>a+(calcPrice(i)?.total||0),0);

  // Category stats with value
  const catMap={};
  items.forEach(i=>{
    if(!catMap[i.category])catMap[i.category]={p:0,g:0,v:0};
    catMap[i.category].p++;
    catMap[i.category].g+=parseFloat(i.gw)||0;
    catMap[i.category].v+=calcPrice(i)?.total||0;
  });

  // Most sold categories
  const soldCatMap={};
  salesVals.forEach(s=>{(s.items||[]).forEach(it=>{
    const cat=it.category||'Other';
    if(!soldCatMap[cat])soldCatMap[cat]={count:0,rev:0};
    soldCatMap[cat].count++;soldCatMap[cat].rev+=it.total||0;
  });});

  const perSArr=salesArr.filter(([k,s])=>inPeriod(s.date));
  const perRev=perSArr.reduce((a,[k,s])=>a+(s.total||0),0);

  document.getElementById('reports-content').innerHTML=`
    <div class="reports-grid">
      <div class="rstat"><div class="rstat-icon">ü™ô</div><div class="rstat-label">TOTAL SALES</div><div class="rstat-val">${inr(totalRev)}</div><div class="rstat-sub">All time ¬∑ ${salesVals.length} bills</div></div>
      <div class="rstat"><div class="rstat-icon">üìÖ</div><div class="rstat-label">TODAY'S SALES</div><div class="rstat-val">${inr(todayRev)}</div><div class="rstat-sub">${todayS.length} bills today</div></div>
      <div class="rstat"><div class="rstat-icon">üì¶</div><div class="rstat-label">CURRENT STOCK</div><div class="rstat-val">${items.length} pcs</div><div class="rstat-sub">${totalGw.toFixed(3)} g total</div></div>
      <div class="rstat"><div class="rstat-icon">üíé</div><div class="rstat-label">STOCK VALUE</div><div class="rstat-val">${inr(totalVal)}</div><div class="rstat-sub">At today's rates</div></div>
    </div>
    <div class="r-inv-bar">
      <div class="r-inv-label">TOTAL INVENTORY VALUE</div>
      <div class="r-inv-val">${inr(totalVal)}</div>
      <div class="r-inv-sub">${items.length} pieces ¬∑ ${totalGw.toFixed(3)}g ¬∑ 24KT ${rates.gold24>0?inr(rates.gold24)+'/g':'‚Äî'}</div>
    </div>

    <div class="r-section-hdr"><span>üì¶</span> Stock by Category</div>
    ${Object.entries(catMap).map(([cat,v])=>`
      <div class="r-cat-row">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="r-cat-icon">${CAT_ICONS[cat]||'‚ú¶'}</div>
          <div><div class="r-cat-name">${cat}</div><div class="r-cat-sub">${v.g.toFixed(3)}g ¬∑ ${v.p} pc${v.p!==1?'s':''}</div></div>
        </div>
        <div style="text-align:right;">
          <div class="r-cat-count">${inr(v.v)}</div>
          <div style="font-size:10px;color:var(--muted);">${v.p} pc${v.p!==1?'s':''}</div>
        </div>
      </div>`).join('')}
    ${Object.keys(catMap).length===0?'<div class="empty-state"><div class="empty-icon">üì¶</div><p>No inventory</p></div>':''}

    <div class="r-section-hdr"><span>üèÜ</span> Most Sold Categories</div>
    ${Object.entries(soldCatMap).sort((a,b)=>b[1].count-a[1].count).slice(0,5).map(([cat,v])=>`
      <div class="r-cat-row">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="r-cat-icon">${CAT_ICONS[cat]||'‚ú¶'}</div>
          <div><div class="r-cat-name">${cat}</div><div class="r-cat-sub">${inr(v.rev)} revenue</div></div>
        </div>
        <div style="text-align:right;"><div class="r-cat-count">${v.count} sold</div></div>
      </div>`).join('')}
    ${Object.keys(soldCatMap).length===0?'<div style="text-align:center;padding:16px;color:var(--muted);font-size:13px;">No sales yet</div>':''}

    <div class="r-section-hdr"><span>üìã</span> Sales Log</div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;">
      ${PERIODS.map(p=>`<button class="period-btn${reportPeriod===p?' active':''}" onclick="reportPeriod='${p}';renderReports();">${PERIOD_LABELS[p]}</button>`).join('')}
    </div>
    <div style="background:var(--gold-bg);border:1px solid var(--gold-border);border-radius:12px;padding:12px 16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:13px;font-weight:600;">${PERIOD_LABELS[reportPeriod]} Revenue</span>
      <span style="font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--gold2);">${inr(perRev)}</span>
    </div>

    ${perSArr.length===0?'<div style="text-align:center;padding:24px;color:var(--muted);font-size:13px;">No sales in this period</div>':
      perSArr.slice().reverse().map(([sKey,s])=>{
        const dStr=new Date(s.date).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
        const tStr=new Date(s.date).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
        return `
        <div class="sale-card">
          <div class="sale-card-header">
            <div>
              <div style="font-size:14px;font-weight:700;color:var(--dark);">${s.customer}${s.phone?' ¬∑ '+s.phone:''}</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px;">${dStr} ¬∑ ${tStr}</div>
              ${s.staff?`<div style="font-size:11px;color:var(--gold2);font-weight:600;margin-top:1px;">Staff: ${s.staff}</div>`:''}
            </div>
            <div style="text-align:right;">
              <div style="font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:700;color:var(--gold2);">${inr(s.total)}</div>
              <button onclick="deleteSale('${sKey}')" style="margin-top:5px;background:none;border:1px solid #FECACA;color:var(--red);border-radius:6px;padding:3px 8px;font-size:10px;cursor:pointer;font-family:'DM Sans',sans-serif;">üóë Delete</button>
            </div>
          </div>
          <div style="font-size:10px;color:var(--muted);letter-spacing:1.2px;text-transform:uppercase;font-weight:600;margin-bottom:6px;">${(s.items||[]).length} Item${(s.items||[]).length!==1?'s':''} Sold</div>
          ${(s.items||[]).map(it=>`
            <div class="sale-item-row">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <div>
                  <div style="font-size:13px;font-weight:600;color:var(--dark);">${it.name}</div>
                  <div style="font-size:11px;color:var(--gold2);font-weight:600;">${it.tag}${it.category?' ¬∑ '+it.category:''}${it.type?' ¬∑ '+it.type:''}</div>
                  <div style="font-size:11px;color:var(--muted);">GW: ${it.gw}g${it.nw&&it.nw!=it.gw?' ¬∑ NW: '+it.nw+'g':''}</div>
                </div>
                <div style="font-family:'Cormorant Garamond',serif;font-size:16px;font-weight:700;color:var(--gold2);">${inr(it.total)}</div>
              </div>
              ${it.goldVal?`<div class="sale-item-charges">Gold: ${inr(it.goldVal)}${it.stoneVal>0?' ¬∑ Stone: '+inr(it.stoneVal):''}${it.diamVal>0?' ¬∑ Diamond: '+inr(it.diamVal):''}${it.making>0?' ¬∑ Making: '+inr(it.making):''}</div>`:''}
            </div>`).join('')}
          ${s.discAmt>0?`<div style="font-size:12px;color:var(--green);margin-top:6px;padding-top:6px;border-top:1px solid var(--border);">Discount on Making (${s.discPct}%): ‚àí${inr(s.discAmt)}</div>`:''}
        </div>`;
      }).join('')}
  `;
}

// ‚ïê‚ïê INIT ‚ïê‚ïê
window.addEventListener('DOMContentLoaded',()=>{
  initFirebase();
  setTimeout(()=>{document.getElementById('loading').style.display='none';document.getElementById('login-screen').style.display='flex';},1100);
});
document.addEventListener('click',e=>{
  if(!e.target.closest('.ac-wrap')&&!e.target.closest('.find-row')){
    document.querySelectorAll('.ac-drop').forEach(d=>d.classList.remove('open'));
  }
});
document.getElementById('owner-modal').addEventListener('click',function(e){if(e.target===this)closeOwnerModal();});
</script>
</body>
</html>
